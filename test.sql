WITH test_cases AS (
  SELECT * FROM UNNEST([
    STRUCT('97124','11426','CPT4','11','S','10801','PH',15.74),
    STRUCT('97124','21044','CPT4','11','S','AP','AP',145.0),
    STRUCT('97124','11758','CPT4','11','S','AP','AP',15.74),
    STRUCT('97124','1760','CPT4','11','S','AP','AP',19.99),
    STRUCT('97124','12524','CPT4','11','S','AP','AP',15.74),
    STRUCT('97124','12524','CPT4','11','S','AP','AP',15.74),
    STRUCT('97124','11706','CPT4','11','S','DC','DC',15.74),
    STRUCT('97124','22304','CPT4','11','S','DC','DC',40.0),
    STRUCT('97124','89511','CPT4','11','S','AP','AP',25.0),
    STRUCT('97124','11706','CPT4','11','S','DC','DC',15.74),
    STRUCT('97124','11201','CPT4','11','S','AP','AP',15.74),
    STRUCT('97124','7090','CPT4','11','S','DC','DC',16.17),
    STRUCT('97124','11201','CPT4','11','S','AP','AP',15.74),
    STRUCT('58300','20190','CPT4','11','S','20101','PH',95.8),
    STRUCT('58300','46040','CPT4','11','S','10201','PH',109.26),
    STRUCT('58300','85018','CPT4','11','S','10201','PH',94.92),
    STRUCT('58300','24060','CPT4','11','S','20101','PH',89.25),
    STRUCT('58300','83835','CPT4','11','S','10201','PH',90.0),
    STRUCT('58300','85224','CPT4','11','S','20101','PH',94.92),
    STRUCT('58300','30316','CPT4','11','S','10301','PH',84.79),
    STRUCT('58300','32541','CPT4','11','S','20101','PH',85.22),
    STRUCT('58300','7410','CPT4','11','S','20101','PH',79.02),
    STRUCT('58300','60540','CPT4','11','S','20101','PH',105.45),
    STRUCT('45380','87109','CPT4','24','S','10301','PH',289.58),
    STRUCT('45380','11530','CPT4','24','S','10307','PH',240.32),
    STRUCT('45380','83687','CPT4','24','S','10307','PH',587.35),
    STRUCT('45380','10075','CPT4','24','S','10301','PH',240.32),
    STRUCT('45380','11570','CPT4','24','S','10307','PH',240.32),
    STRUCT('45380','11223','CPT4','24','S','10301','PH',240.32),
    STRUCT('45380','2920','CPT4','24','S','10307','PH',333.29),
    STRUCT('45380','10577','CPT4','24','S','10201','PH',240.32),
    STRUCT('45380','98226','CPT4','24','S','10307','PH',272.47),
    STRUCT('17000','17015','CPT4','11','S','10601','PH',57.93),
    STRUCT('17000','78163','CPT4','11','S','10601','PH',60.55),
    STRUCT('17000','24060','CPT4','11','S','10601','PH',72.4),
    STRUCT('17000','19106','CPT4','11','S','10601','PH',61.8),
    STRUCT('17000','20176','CPT4','11','S','10601','PH',69.92),
    STRUCT('17000','80218','CPT4','11','S','10601','PH',69.3),
    STRUCT('17000','19087','CPT4','11','S','10601','PH',61.8),
    STRUCT('17000','63127','CPT4','11','S','10601','PH',49.11),
    STRUCT('17000','19006','CPT4','11','S','10601','PH',61.8),
    STRUCT('17000','15228','CPT4','11','S','10601','PH',57.93),
    STRUCT('17000','23111','CPT4','11','S','10601','PH',72.4),
    STRUCT('17000','18901','CPT4','11','S','10601','PH',61.8),
    STRUCT('17000','7675','CPT4','11','S','10601','PH',61.48),
    STRUCT('17000','78006','CPT4','11','S','10601','PH',60.55),
    STRUCT('17000','44145','CPT4','11','S','10601','PH',55.38),
    STRUCT('17000','83814','CPT4','11','S','10601','PH',88.53),
    STRUCT('17000','8054','CPT4','11','S','10601','PH',66.6),
    STRUCT('17000','29492','CPT4','11','S','10601','PH',72.32),
    STRUCT('17000','64154','CPT4','11','S','10601','PH',57.26),
    STRUCT('17000','22209','CPT4','11','S','10601','PH',69.92),
    STRUCT('45378','24014','CPT4','24','S','10307','PH',211.85),
    STRUCT('45378','99352','CPT4','24','S','30201','PH',251.28),
    STRUCT('45378','66048','CPT4','24','S','10307','PH',190.8),
    STRUCT('45378','43623','CPT4','24','S','10307','PH',184.52),
    STRUCT('55250','83814','CPT4','11','S','31001','PH',495.92),
    STRUCT('55250','90720','CPT4','11','S','31001','PH',462.02),
    STRUCT('55250','77584','CPT4','11','S','31001','PH',394.14),
    STRUCT('55250','27834','CPT4','11','S','31001','PH',328.35),
    STRUCT('55250','77584','CPT4','11','S','31001','PH',394.14),
    STRUCT('55250','97062','CPT4','11','S','31001','PH',520.54),
    STRUCT('55250','35758','CPT4','11','S','31001','PH',500.96),
    STRUCT('97112','8215','CPT4','11','S','OT','OT',19.36),
    STRUCT('97112','11731','CPT4','11','S','PT','PT',20.29),
    STRUCT('97112','6611','CPT4','11','S','PT','PT',108.9),
    STRUCT('97112','7054','CPT4','11','S','PT','PT',20.87),
    STRUCT('97112','7052','CPT4','11','S','PT','PT',20.87),
    STRUCT('97112','6810','CPT4','11','S','PT','PT',31.07),
    STRUCT('97112','84660','CPT4','11','S','PT','PT',32.94),
    STRUCT('97112','78258','CPT4','11','S','PT','PT',22.04),
    STRUCT('97112','7834','CPT4','11','S','PT','PT',20.87),
    STRUCT('97112','21084','CPT4','11','S','PT','PT',24.99),
    STRUCT('97112','84010','CPT4','11','S','PT','PT',32.94),
    STRUCT('97112','7834','CPT4','11','S','PT','PT',20.87),
    STRUCT('97112','23059','CPT4','11','S','PT','PT',22.99),
    STRUCT('97112','10016','CPT4','11','S','PT','PT',20.29),
    STRUCT('97112','22193','CPT4','11','S','PT','PT',26.44),
    STRUCT('97112','11510','CPT4','11','S','PT','PT',20.29),
    STRUCT('97112','13827','CPT4','11','S','PT','PT',16.19),
    STRUCT('97112','99508','CPT4','11','S','PT','PT',66.39),
    STRUCT('97112','60175','CPT4','11','S','PT','PT',27.5),
    STRUCT('97112','93551','CPT4','11','S','10801','PH',22.61),
    STRUCT('97112','78258','CPT4','11','S','PT','PT',22.04),
    STRUCT('97112','84660','CPT4','11','S','PT','PT',32.94),
    STRUCT('97112','20005','CPT4','11','S','PT','PT',26.44),
    STRUCT('97112','11731','CPT4','11','S','PT','PT',20.29),
    STRUCT('97112','22314','CPT4','11','S','PT','PT',26.44),
    STRUCT('97112','98029','CPT4','11','S','PT','PT',33.18),
    STRUCT('97112','20007','CPT4','11','S','PT','PT',26.44),
    STRUCT('97112','10541','CPT4','11','S','PT','PT',20.29),
    STRUCT('97112','84095','CPT4','11','S','PT','PT',32.94),
    STRUCT('97112','84010','CPT4','11','S','PT','PT',32.94),
    STRUCT('97112','11354','CPT4','11','S','DC','DC',20.29),
    STRUCT('97112','6470','CPT4','11','S','DC','DC',31.07),
    STRUCT('97811','21015','CPT4','11','S','AP','AP',26.59),
    STRUCT('97811','10003','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','7649','CPT4','11','S','AP','AP',38.42),
    STRUCT('97811','11790','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','6880','CPT4','11','S','AP','AP',74.82),
    STRUCT('97811','20814','CPT4','11','S','AP','AP',27.49),
    STRUCT('97811','10032','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','10021','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','22314','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','60563','CPT4','11','S','10301','MPG',60.64),
    STRUCT('97811','99503','CPT4','11','S','AP','AP',128.22),
    STRUCT('97811','11790','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','10003','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','10038','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','20008','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','80233','CPT4','11','S','AP','AP',62.52),
    STRUCT('97811','22003','CPT4','11','S','AP','AP',27.49),
    STRUCT('97811','10011','CPT4','11','S','AP','AP',46.76),
    STRUCT('97811','21230','CPT4','11','S','AP','AP',53.18),
    STRUCT('97811','10003','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','11784','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','11596','CPT4','11','S','AP','AP',46.76),
    STRUCT('97811','20850','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','7042','CPT4','11','S','AP','AP',38.42),
    STRUCT('97811','30329','CPT4','11','S','AP','AP',25.26),
    STRUCT('97811','21208','CPT4','11','S','AP','AP',53.18),
    STRUCT('97811','21046','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','99508','CPT4','11','S','AP','AP',64.11),
    STRUCT('97811','10021','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','10032','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','60618','CPT4','11','S','BHG','BHG',60.64),
    STRUCT('97811','19355','CPT4','11','S','AP','AP',62.78),
    STRUCT('97811','10021','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','10032','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','20008','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','11596','CPT4','11','S','AP','AP',46.76),
    STRUCT('97811','30009','CPT4','11','S','AP','AP',50.52),
    STRUCT('97811','20036','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','10003','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','10021','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','20852','CPT4','11','S','AP','AP',50.0),
    STRUCT('97811','99801','CPT4','11','S','AP','AP',128.22),
    STRUCT('97811','75231','CPT4','11','S','AP','AP',44.66),
    STRUCT('97811','22204','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','20814','CPT4','11','S','AP','AP',27.49),
    STRUCT('97811','10001','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','20009','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','20817','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','10011','CPT4','11','S','AP','AP',46.76),
    STRUCT('97811','98125','CPT4','11','S','ND','ND',70.94),
    STRUCT('97811','22101','CPT4','11','S','AP','AP',27.49),
    STRUCT('97811','60618','CPT4','11','S','BHG','BHG',60.64),
    STRUCT('97811','20009','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','20121','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','20740','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','89509','CPT4','11','S','AP','AP',66.26),
    STRUCT('97811','12205','CPT4','11','S','AP','AP',60.0),
    STRUCT('97811','20850','CPT4','11','S','AP','AP',27.49),
    STRUCT('97811','22101','CPT4','11','S','AP','AP',27.49),
    STRUCT('97811','21044','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','19094','CPT4','11','S','AP','AP',62.78),
    STRUCT('97811','10003','CPT4','11','S','AP','AP',46.76),
    STRUCT('97811','33178','CPT4','11','S','AP','AP',43.52),
    STRUCT('97811','8505','CPT4','11','S','AP','AP',54.22),
    STRUCT('97811','10543','CPT4','11','S','10401','PH',23.38),
    STRUCT('97811','7450','CPT4','11','S','AP','AP',19.21),
    STRUCT('97811','10032','CPT4','11','S','AP','AP',23.38),
    STRUCT('97811','22204','CPT4','11','S','DC','DC',54.98),
    STRUCT('97811','20121','CPT4','11','S','AP','AP',54.98),
    STRUCT('97811','10016','CPT4','11','S','AP','AP',46.76),
    STRUCT('97811','20009','CPT4','11','S','AP','AP',54.98),
    STRUCT('92014','4039','CPT4','11','S','OP','OP',141.7),
    STRUCT('92014','7712','CPT4','11','S','30401','PH',80.1),
    STRUCT('92014','85653','CPT4','11','S','30401','PH',115.64),
    STRUCT('92014','99701','CPT4','11','S','OP','OP',275.0),
    STRUCT('92014','98382','CPT4','11','S','OP','OP',165.0),
    STRUCT('92014','10583','CPT4','11','S','10414','PH',94.41),
    STRUCT('92014','99801','CPT4','11','S','OP','OP',240.0),
    STRUCT('92014','6902','CPT4','11','S','OP','OP',142.42),
    STRUCT('92014','64068','CPT4','11','S','30401','PH',96.15),
    STRUCT('92014','32605','CPT4','11','S','30401','PH',87.12),
    STRUCT('92014','44121','CPT4','11','S','10414','PH',103.58),
    STRUCT('92014','10577','CPT4','11','S','10414','PH',94.41),
    STRUCT('92014','12078','CPT4','11','S','30401','PH',156.83),
    STRUCT('92014','33334','CPT4','11','S','30401','PH',90.99),
    STRUCT('92014','99503','CPT4','11','S','OP','OP',339.0),
    STRUCT('92014','60048','CPT4','11','S','30401','PH',109.02),
    STRUCT('92014','11375','CPT4','11','S','30401','PH',94.41),
    STRUCT('92014','63376','CPT4','11','S','30401','PH',108.06),
    STRUCT('92014','98115','CPT4','11','S','OP','OP',173.71),
    STRUCT('76830','90069','CPT4','11','S','20101','PH',126.18),
    STRUCT('76830','35243','CPT4','11','S','20101','PH',153.45),
    STRUCT('76830','10019','CPT4','11','S','20105','PH',95.31),
    STRUCT('76830','89511','CPT4','11','S','20101','PH',134.45),
    STRUCT('76830','7649','CPT4','11','S','PAS','PAS',192.0),
    STRUCT('92015','27265','CPT4','11','S','OP','OP',19.42),
    STRUCT('92015','46582','CPT4','11','S','OP','OP',16.23),
    STRUCT('92015','64068','CPT4','11','S','OP','OP',14.82),
    STRUCT('92015','7109','CPT4','11','S','30401','PH',35.0),
    STRUCT('92015','20815','CPT4','11','S','OP','OP',35.5),
    STRUCT('92015','37849','CPT4','11','S','30401','OP',19.12),
    STRUCT('92015','23430','CPT4','11','S','OP','OP',17.03),
    STRUCT('92015','7974','CPT4','11','S','OP','OP',36.15),
    STRUCT('92015','98026','CPT4','11','S','OP','OP',25.78),
    STRUCT('92015','10577','CPT4','11','S','30401','PH',16.92),
    STRUCT('92015','8816','CPT4','11','S','OP','OP',36.15),
    STRUCT('92015','4240','CPT4','11','S','OP','OP',22.44),
    STRUCT('92015','98409','CPT4','11','S','OP','OP',25.78),
    STRUCT('92015','11418','CPT4','11','S','30401','PH',16.92),
    STRUCT('92015','14850','CPT4','11','S','OP','OP',21.04),
    STRUCT('92015','16501','CPT4','11','S','10414','PH',19.19),
    STRUCT('92015','6105','CPT4','11','S','OP','OP',22.36),
    STRUCT('92015','8648','CPT4','11','S','OP','OP',20.94),
    STRUCT('92015','20715','CPT4','11','S','30401','PH',30.0),
    STRUCT('97110','11757','CPT4','11','S','PT','PT',68.26),
    STRUCT('97110','7632','CPT4','11','S','DC','DC',20.28),
    STRUCT('97110','28584','CPT4','11','S','PT','PT',24.64),
    STRUCT('97110','18337','CPT4','11','S','DC','DC',20.14),
    STRUCT('97110','7024','CPT4','11','S','DC','DC',20.28),
    STRUCT('97110','7023','CPT4','11','S','DC','DC',20.28),
    STRUCT('97110','21228','CPT4','11','S','PT','PT',21.76),
    STRUCT('97110','36532','CPT4','11','S','DC','DC',27.93),
    STRUCT('97110','27573','CPT4','11','S','DC','DC',24.64),
    STRUCT('97110','28607','CPT4','11','S','DC','DC',24.64),
    STRUCT('97110','11426','CPT4','11','S','10801','PH',68.26),
    STRUCT('97110','82901','CPT4','11','S','PT','PT',30.0),
    STRUCT('97110','95128','CPT4','11','S','AP','AP',21.99),
    STRUCT('97110','40299','CPT4','11','S','DC','DC',19.58),
    STRUCT('97110','30308','CPT4','11','S','DC','DC',19.67),
    STRUCT('97110','29512','CPT4','11','S','DC','DC',20.75),
    STRUCT('97110','11361','CPT4','11','S','DC','DC',19.41),
    STRUCT('97110','7663','CPT4','11','S','DC','DC',20.28),
    STRUCT('97110','12553','CPT4','11','S','11002','PH',58.88),
    STRUCT('97110','18017','CPT4','11','S','DC','DC',19.36),
    STRUCT('97110','99709','CPT4','11','S','PT','PT',58.1),
    STRUCT('97110','11426','CPT4','11','S','10801','PH',19.41),
    STRUCT('97110','10509','CPT4','11','S','PT','PT',58.88),
    STRUCT('97110','11793','CPT4','11','S','PT','PT',58.88),
    STRUCT('97110','20852','CPT4','11','S','DC','DC',22.98),
    STRUCT('97110','8527','CPT4','11','S','DC','DC',20.28),
    STRUCT('97110','10704','CPT4','11','S','DC','DC',68.26),
    STRUCT('97110','95128','CPT4','11','S','AP','AP',21.99),
    STRUCT('97110','10007','CPT4','11','S','DC','DC',19.41),
    STRUCT('97110','11354','CPT4','11','S','DC','DC',19.41),
    STRUCT('97110','2359','CPT4','11','S','DC','DC',24.22),
    STRUCT('97110','2896','CPT4','11','S','PT','PT',27.73),
    STRUCT('97110','18042','CPT4','11','S','DC','DC',19.36),
    STRUCT('97110','57110','CPT4','11','S','DC','DC',20.76),
    STRUCT('97110','6905','CPT4','11','S','DC','DC',29.73),
    STRUCT('97110','7731','CPT4','11','S','DC','DC',20.28),
    STRUCT('97110','75093','CPT4','11','S','DC','DC',14.04),
    STRUCT('97110','12205','CPT4','11','S','DC','DC',15.37),
    STRUCT('97110','20164','CPT4','11','S','DC','DC',22.98),
    STRUCT('97110','33812','CPT4','11','S','DC','DC',16.56),
    STRUCT('99386','33756','CPT4','11','S','10201','PH',104.35),
    STRUCT('99386','11203','CPT4','11','S','20101','PH',114.17),
    STRUCT('99386','60605','CPT4','11','S','10601','PH',136.42),
    STRUCT('99386','33611','CPT4','11','S','10301','PH',104.35),
    STRUCT('99386','35758','CPT4','11','S','20101','PH',131.13),
    STRUCT('99386','12189','CPT4','11','S','10301','PH',145.98),
    STRUCT('99386','19104','CPT4','11','S','20101','PH',129.83),
    STRUCT('99386','20121','CPT4','11','S','10301','PH',147.9),
    STRUCT('99386','89120','CPT4','11','S','10301','PH',118.93),
    STRUCT('99386','8619','CPT4','11','S','10301','PH',127.75),
    STRUCT('99386','22182','CPT4','11','S','10301','PH',147.9),
    STRUCT('99386','91786','CPT4','11','S','10201','PH',114.8),
    STRUCT('99386','10022','CPT4','11','S','20101','PH',114.17),
    STRUCT('99386','33414','CPT4','11','S','10201','PH',119.35),
    STRUCT('98940','10536','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','70119','CPT4','11','S','DC','DC',23.56),
    STRUCT('98940','70506','CPT4','11','S','DC','DC',25.04),
    STRUCT('98940','45044','CPT4','11','S','DC','DC',19.08),
    STRUCT('98940','27889','CPT4','11','S','DC','DC',18.98),
    STRUCT('98940','22801','CPT4','11','S','DC','DC',17.16),
    STRUCT('98940','11580','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','27889','CPT4','11','S','DC','DC',18.98),
    STRUCT('98940','10301','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','28105','CPT4','11','S','DC','DC',18.98),
    STRUCT('98940','8807','CPT4','11','S','DC','DC',17.47),
    STRUCT('98940','7078','CPT4','11','S','DC','DC',17.47),
    STRUCT('98940','62959','CPT4','11','S','DC','DC',21.29),
    STRUCT('98940','7834','CPT4','11','S','DC','DC',17.47),
    STRUCT('98940','23456','CPT4','11','S','DC','DC',17.16),
    STRUCT('98940','22044','CPT4','11','S','DC','DC',19.39),
    STRUCT('98940','12545','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','38024','CPT4','11','S','DC','DC',16.62),
    STRUCT('98940','22202','CPT4','11','S','DC','DC',19.39),
    STRUCT('98940','28173','CPT4','11','S','DC','DC',18.98),
    STRUCT('98940','7834','CPT4','11','S','DC','DC',17.47),
    STRUCT('98940','23321','CPT4','11','S','DC','DC',17.16),
    STRUCT('98940','63118','CPT4','11','S','DC','DC',21.29),
    STRUCT('98940','6119','CPT4','11','S','DC','DC',29.49),
    STRUCT('98940','11572','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','18901','CPT4','11','S','DC','DC',17.95),
    STRUCT('98940','24153','CPT4','11','S','DC','DC',17.16),
    STRUCT('98940','8027','CPT4','11','S','DC','DC',15.8),
    STRUCT('98940','10305','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','21224','CPT4','11','S','DC','DC',18.46),
    STRUCT('98940','11010','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','21234','CPT4','11','S','DC','DC',18.46),
    STRUCT('98940','12866','CPT4','11','S','DC','DC',20.01),
    STRUCT('98940','10704','CPT4','11','S','DC','DC',16.53),
    STRUCT('98940','38355','CPT4','11','S','DC','DC',17.42),
    STRUCT('98940','28207','CPT4','11','S','DC','DC',18.98),
    STRUCT('98940','92653','CPT4','11','S','DC','DC',24.0),
    STRUCT('98940','22046','CPT4','11','S','DC','DC',19.39),
    STRUCT('99385','98104','CPT4','11','S','10201','PH',172.23),
    STRUCT('99385','7104','CPT4','11','S','20101','PH',113.72),
    STRUCT('99385','89128','CPT4','11','S','10201','PH',102.82),
    STRUCT('99385','23229','CPT4','11','S','10401','PH',117.57),
    STRUCT('99385','33611','CPT4','11','S','10301','PH',89.35),
    STRUCT('99385','10601','CPT4','11','S','10301','PH',98.28),
    STRUCT('99385','89052','CPT4','11','S','20101','PH',102.82),
    STRUCT('99385','60187','CPT4','11','S','90351','NP',118.51),
    STRUCT('99385','98034','CPT4','11','S','10301','PH',172.23),
    STRUCT('97810','22003','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','10075','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','98052','CPT4','11','S','AP','AP',42.75),
    STRUCT('97810','90815','CPT4','11','S','AP','AP',34.07),
    STRUCT('97810','11733','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','90025','CPT4','11','S','AP','AP',34.07),
    STRUCT('97810','33511','CPT4','11','S','DC','DC',29.57),
    STRUCT('97810','90703','CPT4','11','S','AP','AP',34.07),
    STRUCT('97810','98391','CPT4','11','S','AP','AP',42.75),
    STRUCT('97810','21401','CPT4','11','S','AP','AP',35.27),
    STRUCT('97810','12065','CPT4','11','S','AP','AP',46.4),
    STRUCT('97810','20036','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','10011','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','48377','CPT4','11','S','10801','PH',49.14),
    STRUCT('97810','19454','CPT4','11','S','AP','AP',41.95),
    STRUCT('97810','20009','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','10016','CPT4','11','S','AP','AP',0.0),
    STRUCT('97810','33178','CPT4','11','S','AP','AP',29.14),
    STRUCT('97810','11201','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','20121','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','8003','CPT4','11','S','AP','AP',36.13),
    STRUCT('97810','8054','CPT4','11','S','AP','AP',36.13),
    STRUCT('97810','6804','CPT4','11','S','AP','AP',50.34),
    STRUCT('97810','20036','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','6107','CPT4','11','S','AP','AP',50.34),
    STRUCT('97810','91748','CPT4','11','S','AP','AP',34.07),
    STRUCT('97810','10025','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','80111','CPT4','11','S','AP','AP',41.66),
    STRUCT('97810','22030','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','8322','CPT4','11','S','AP','AP',36.13),
    STRUCT('97810','1760','CPT4','11','S','AP','AP',35.03),
    STRUCT('97810','84095','CPT4','11','S','AP','AP',41.42),
    STRUCT('97810','33326','CPT4','11','S','AP','AP',29.14),
    STRUCT('97810','11701','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','20814','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','21042','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','22003','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','20024','CPT4','11','S','DC','DC',36.72),
    STRUCT('97810','22101','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','22003','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','33178','CPT4','11','S','AP','AP',29.14),
    STRUCT('97810','10017','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','11780','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','21210','CPT4','11','S','AP','AP',35.27),
    STRUCT('97810','90069','CPT4','11','S','AP','AP',34.07),
    STRUCT('97810','22003','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','10016','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','89502','CPT4','11','S','AP','AP',43.99),
    STRUCT('97810','20008','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','22031','CPT4','11','S','DC','DC',36.72),
    STRUCT('97810','22204','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','7059','CPT4','11','S','AP','AP',25.05),
    STRUCT('97810','6119','CPT4','11','S','AP','AP',50.34),
    STRUCT('97810','20151','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','22401','CPT4','11','S','AP','AP',36.72),
    STRUCT('97810','10011','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','11779','CPT4','11','S','AP','AP',31.49),
    STRUCT('97810','99503','CPT4','11','S','ND','ND',83.92),
    STRUCT('98943','7825','CPT4','11','S','DC','DC',16.79),
    STRUCT('98943','8691','CPT4','11','S','DC','DC',15.67),
    STRUCT('98943','18810','CPT4','11','S','DC','DC',16.01),
    STRUCT('98943','2038','CPT4','11','S','DC','DC',20.32),
    STRUCT('98943','21740','CPT4','11','S','DC','DC',17.0),
    STRUCT('98943','28083','CPT4','11','S','DC','DC',18.23),
    STRUCT('98943','45409','CPT4','11','S','DC','DC',18.77),
    STRUCT('98943','15090','CPT4','11','S','DC','DC',16.01),
    STRUCT('98943','4102','CPT4','11','S','DC','DC',28.48),
    STRUCT('98943','8054','CPT4','11','S','DC','DC',15.67),
    STRUCT('98943','6897','CPT4','11','S','DC','DC',27.96),
    STRUCT('98943','29464','CPT4','11','S','DC','DC',17.66),
    STRUCT('98943','14217','CPT4','11','S','DC','DC',19.14),
    STRUCT('98943','62704','CPT4','11','S','DC','DC',19.68),
    STRUCT('98943','19460','CPT4','11','S','DC','DC',17.34),
    STRUCT('98943','27889','CPT4','11','S','DC','DC',18.23),
    STRUCT('98943','10007','CPT4','11','S','DC','DC',15.99),
    STRUCT('98943','27932','CPT4','11','S','DC','DC',18.23),
    STRUCT('98943','4473','CPT4','11','S','DC','DC',28.48),
    STRUCT('98943','98270','CPT4','11','S','DC','DC',25.69),
    STRUCT('98943','22044','CPT4','11','S','DC','DC',18.38),
    STRUCT('98943','20850','CPT4','11','S','DC','DC',18.38),
    STRUCT('98943','28607','CPT4','11','S','DC','DC',18.23),
    STRUCT('98943','64116','CPT4','11','S','DC','DC',19.68),
    STRUCT('98943','20010','CPT4','11','S','DC','DC',18.38),
    STRUCT('98943','8804','CPT4','11','S','DC','DC',16.79),
    STRUCT('98943','95376','CPT4','11','S','DC','DC',22.0),
    STRUCT('98943','7090','CPT4','11','S','DC','DC',16.79),
    STRUCT('98943','33624','CPT4','11','S','DC','DC',15.0),
    STRUCT('98943','8094','CPT4','11','S','DC','DC',15.67),
    STRUCT('98943','78664','CPT4','11','S','DC','DC',15.08),
    STRUCT('98943','22151','CPT4','11','S','DC','DC',18.38),
    STRUCT('98943','70737','CPT4','11','S','DC','DC',26.08),
    STRUCT('98943','8012','CPT4','11','S','DC','DC',15.67),
    STRUCT('98943','78757','CPT4','11','S','DC','DC',15.08),
    STRUCT('98943','28277','CPT4','11','S','DC','DC',18.23),
    STRUCT('80053','53226','CPT4','81','S','LB','LB',12.67),
    STRUCT('99213','23112','CPT4','11','S','10401','PH',73.07),
    STRUCT('99213','20147','CPT4','11','S','10601','PH',73.38),
    STRUCT('99213','63090','CPT4','11','S','10401','PH',63.23),
    STRUCT('99213','98133','CPT4','11','S','10401','PH',103.82),
    STRUCT('99213','20152','CPT4','11','S','20101','PH',73.38),
    STRUCT('99213','98166','CPT4','11','S','10401','PH',103.82),
    STRUCT('99213','8742','CPT4','11','S','10401','PH',53.51),
    STRUCT('99213','48323','CPT4','11','S','10401','PH',91.58),
    STRUCT('99213','22408','CPT4','11','S','10313','PH',73.38),
    STRUCT('99213','48323','CPT4','11','S','10401','PH',91.58),
    STRUCT('99213','20176','CPT4','11','S','10401','PH',73.38),
    STRUCT('98941','61821','CPT4','11','S','DC','DC',28.29),
    STRUCT('98941','20754','CPT4','11','S','DC','DC',26.48),
    STRUCT('98941','89523','CPT4','11','S','DC','DC',30.29),
    STRUCT('98941','8610','CPT4','11','S','DC','DC',23.12),
    STRUCT('98941','8096','CPT4','11','S','DC','DC',23.12),
    STRUCT('98941','22180','CPT4','11','S','DC','DC',27.74),
    STRUCT('98941','97013','CPT4','11','S','DC','DC',31.2),
    STRUCT('98941','34453','CPT4','11','S','DC','DC',21.59),
    STRUCT('98941','27596','CPT4','11','S','DC','DC',27.29),
    STRUCT('98941','89521','CPT4','11','S','DC','DC',30.29),
    STRUCT('98941','47025','CPT4','11','S','DC','DC',27.42),
    STRUCT('98941','89123','CPT4','11','S','DC','DC',30.29),
    STRUCT('98941','27615','CPT4','11','S','DC','DC',27.29),
    STRUCT('98941','8043','CPT4','11','S','DC','DC',23.12),
    STRUCT('98941','99503','CPT4','11','S','DC','DC',84.44),
    STRUCT('98941','34109','CPT4','11','S','DC','DC',21.59),
    STRUCT('98941','75087','CPT4','11','S','DC','DC',22.93),
    STRUCT('98941','8094','CPT4','11','S','DC','DC',23.12),
    STRUCT('98941','34652','CPT4','11','S','DC','DC',21.59),
    STRUCT('98941','4605','CPT4','11','S','DC','DC',42.24),
    STRUCT('98941','27932','CPT4','11','S','DC','DC',27.29),
    STRUCT('98941','50111','CPT4','11','S','DC','DC',25.34),
    STRUCT('98941','34209','CPT4','11','S','DC','DC',21.59),
    STRUCT('98941','84770','CPT4','11','S','DC','DC',35.0),
    STRUCT('98941','27028','CPT4','11','S','DC','DC',27.29),
    STRUCT('98941','8550','CPT4','11','S','DC','DC',23.12),
    STRUCT('98941','37128','CPT4','11','S','DC','DC',23.96),
    STRUCT('98941','29841','CPT4','11','S','DC','DC',26.93),
    STRUCT('98941','14072','CPT4','11','S','DC','DC',28.74),
    STRUCT('98941','98233','CPT4','11','S','DC','DC',38.61),
    STRUCT('98941','27573','CPT4','11','S','DC','DC',27.29),
    STRUCT('98941','61761','CPT4','11','S','DC','DC',57.78),
    STRUCT('98941','28328','CPT4','11','S','DC','DC',27.29),
    STRUCT('98941','27262','CPT4','11','S','DC','DC',27.29),
    STRUCT('98941','23229','CPT4','11','S','DC','DC',24.91),
    STRUCT('98941','7030','CPT4','11','S','DC','DC',24.43),
    STRUCT('90837','77079','CPT4','11','S','LPC','LPC',114.01),
    STRUCT('90837','99686','CPT4','11','S','SW','SW',169.37),
    STRUCT('90837','72015','CPT4','11','S','LPC','LPC',78.49),
    STRUCT('90837','89106','CPT4','11','S','SW','SW',110.02),
    STRUCT('90837','67230','CPT4','11','S','MT','MT',105.97),
    STRUCT('90837','28734','CPT4','11','S','BHG','BHG',166.0),
    STRUCT('90837','46055','CPT4','11','S','CP','CP',142.78),
    STRUCT('90837','84041','CPT4','11','S','SW','SW',92.39),
    STRUCT('90837','8753','CPT4','11','S','LPC','LPC',127.86),
    STRUCT('90837','43065','CPT4','11','S','SW','SW',104.21),
    STRUCT('90837','43023','CPT4','11','S','SW','SW',104.21),
    STRUCT('90837','60618','CPT4','11','S','LPC','LPC',116.05),
    STRUCT('90837','28078','CPT4','11','S','SW','SW',138.61),
    STRUCT('90837','11101','CPT4','11','S','CP','CP',160.89),
    STRUCT('90837','84790','CPT4','11','S','SW','SW',92.39),
    STRUCT('90837','32901','CPT4','11','S','SW','SW',102.94),
    STRUCT('90837','60435','CPT4','11','S','LPC','LPC',116.05),
    STRUCT('90837','99206','CPT4','11','S','CP','CP',142.69),
    STRUCT('90837','99352','CPT4','11','S','91006','LPC',142.69),
    STRUCT('90837','11756','CPT4','11','S','BHG','BHG',160.89),
    STRUCT('90837','27511','CPT4','11','S','BHG','BHG',184.81),
    STRUCT('90837','60510','CPT4','11','S','BHG','BHG',154.74),
    STRUCT('90837','11758','CPT4','11','S','SW','SW',120.67),
    STRUCT('90837','60091','CPT4','11','S','SW','SW',116.05),
    STRUCT('90837','33467','CPT4','11','S','SW','SW',79.29),
    STRUCT('90837','83202','CPT4','11','S','CP','CP',144.0),
    STRUCT('90837','8534','CPT4','11','S','BHG','BHG',160.14),
    STRUCT('90837','84790','CPT4','11','S','MT','MT',92.39),
    STRUCT('90837','96002','CPT4','11','S','BHG','BHG',100.0),
    STRUCT('90837','8534','CPT4','11','S','BHG','BHG',160.14),
    STRUCT('90837','98201','CPT4','11','S','CP','CP',142.69),
    STRUCT('90837','60416','CPT4','11','S','SW','SW',110.93),
    STRUCT('90837','18940','CPT4','11','S','LPC','LPC',110.21),
    STRUCT('90837','84043','CPT4','11','S','LPC','LPC',92.39),
    STRUCT('90837','61350','CPT4','11','S','SW','SW',108.75),
    STRUCT('90837','67212','CPT4','11','S','MT','MT',105.97),
    STRUCT('90837','60062','CPT4','11','S','BHG','BHG',154.74),
    STRUCT('90837','8043','CPT4','11','S','SW','SW',120.1),
    STRUCT('90837','67037','CPT4','11','S','MT','MT',105.97),
    STRUCT('90837','39157','CPT4','11','S','BHG','BHG',145.0),
    STRUCT('90837','19512','CPT4','11','S','LPC','LPC',112.35),
    STRUCT('90837','44145','CPT4','11','S','LPC','LPC',104.21),
    STRUCT('90837','82930','CPT4','11','S','LPC','LPC',116.09),
    STRUCT('90837','20904','CPT4','11','S','LPC','LPC',101.35),
    STRUCT('90837','60301','CPT4','11','S','BHG','BHG',154.74)
  ]) AS test_cases(
    service_code, 
    zip_code, 
    service_type_code, 
    place_of_service_code, 
    contract_type_standard, 
    specialty_code, 
    provider_type_code, 
    allowed_amount
  )
),

Standard_zips AS (
    SELECT DISTINCT
        tc.service_code,
        tc.zip_code,
        tc.specialty_code,
        tc.service_type_code,
        tc.place_of_service_code,
        tc.contract_type_standard,
        tc.allowed_amount,
        t1.ZIP_CD,
        t1.RATING_SYSTEM_CD AS TIN_RATING_SYSTEM_CD,
        t1.GEOGRAPHIC_AREA_CD AS tin_GEOGRAPHIC_AREA_CD,
        t3.GEOGRAPHIC_AREA_CD,
        t3.OVERRIDE_RATE_SYSTEM_CD
    FROM test_cases tc
    JOIN `prv_ps_ce_hcb_dev.CET_EPDB_TAX_IDENTIFICATION_NUMBER_ADDRESS_DETAIL_VIEW` t1
      ON t1.ZIP_CD = tc.zip_code
    LEFT JOIN `prv_ps_ce_hcb_dev.CET_EPDB_CONTRACT_PROVIDER_BUSINESS_GROUP_VIEW` t2
      ON t1.provider_identification_nbr = t2.provider_identification_nbr
     AND t1.tax_identification_nbr     = t2.tax_identification_nbr
     AND t1.service_location_nbr       = t2.service_location_nbr
     AND t1.network_id                 = t2.network_id
    LEFT JOIN `prv_ps_ce_hcb_dev.CET_SCSR_RATE_OVERRIDE_VIEW` t3
      ON t1.ZIP_CD          = t3.GEOGRAPHIC_AREA_CD
     AND t1.RATING_SYSTEM_CD = t3.RATE_SYSTEM_CD
    WHERE t2.provider_business_group_nbr IS NULL
      AND (t3.OVERRIDE_RATE_SYSTEM_CD = '' OR t3.OVERRIDE_RATE_SYSTEM_CD IS NULL)
),

rate_results AS (
    SELECT DISTINCT
        sp.service_code,
        sp.zip_code,
        sp.specialty_code,
        sp.service_type_code,
        sp.place_of_service_code,
        sp.contract_type_standard,
        sp.allowed_amount,
        t4.RATE_SYSTEM_CD,
        t4.SERVICE_CD,
        t4.SERVICE_TYPE_CD,
        sp.tin_GEOGRAPHIC_AREA_CD AS GEOGRAPHIC_AREA_CD,
        t4.SPECIALTY_CD,
        t4.SPECIALTY_TYPE_CD,
        CAST(t4.RATE_AMT AS FLOAT64) AS RATE
    FROM Standard_zips sp
    JOIN `prv_ps_ce_hcb_dev.CET_SCSR_RATE_DETAIL_VIEW` t4
      ON t4.RATE_SYSTEM_CD     = sp.TIN_RATING_SYSTEM_CD
     AND t4.GEOGRAPHIC_AREA_CD = sp.tin_GEOGRAPHIC_AREA_CD
    JOIN `prv_ps_ce_hcb_dev.CET_SCSR_DIFFERENTIATION_CRITERIA_VIEW` tsdc
      ON tsdc.differentiation_criteria_id = t4.differentiation_criteria_id
    JOIN `prv_ps_ce_dec_hcb_dev.service_code_master` scm
      ON TRIM(scm.primary_svc_cd) = t4.SERVICE_CD
    WHERE t4.EXTENSION_CD = ''
      AND scm.in_scope_ind = 1
      AND scm.trmn_dt > CURRENT_DATE()
      AND scm.primary_svc_cd = sp.service_code
),

cet_rates_result AS (
    SELECT 
        rr.service_code,
        rr.zip_code,
        rr.allowed_amount,
        rr.RATE_SYSTEM_CD,
        rr.GEOGRAPHIC_AREA_CD,
        cr.SPECIALTY_CD,
        cr.SPECIALTY_TYPE_CD,
        cr.rate
    FROM rate_results rr
    JOIN `prv_ps_ce_dec_hcb_dev.CET_RATES` cr
      ON cr.RATE_SYSTEM_CD = rr.RATE_SYSTEM_CD
     AND cr.GEOGRAPHIC_AREA_CD = rr.GEOGRAPHIC_AREA_CD
    WHERE cr.SERVICE_CD = rr.service_code
      AND cr.SERVICE_TYPE_CD = rr.service_type_code
      AND cr.PLACE_OF_SERVICE_CD = rr.place_of_service_code
      AND cr.CONTRACT_TYPE = rr.contract_type_standard
      -- AND cr.SPECIALTY_CD = rr.specialty_code
      AND cr.RATE = rr.allowed_amount
)

-- Final result: All test cases with rate_found flag
SELECT 
    tc.zip_code,
    tc.service_code,
    tc.allowed_amount,
    CASE WHEN cr.zip_code IS NOT NULL THEN 1 ELSE 0 END AS rate_found
FROM test_cases tc
LEFT JOIN cet_rates_result cr
  ON tc.zip_code = cr.zip_code
 AND tc.service_code = cr.service_code
 AND tc.allowed_amount = cr.allowed_amount
GROUP BY tc.zip_code, tc.service_code, tc.allowed_amount, rate_found
ORDER BY tc.zip_code, tc.service_code;
